---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import ProductCard from '../components/ProductCard.astro';
import ContactSection from '../components/ContactSection.astro'; // Aggiunto per coerenza
import { getCollection } from 'astro:content';

// Recupero tutti i prodotti
const prodotti = await getCollection('prodotti');

// Estraggo le categorie uniche
const categorie = [...new Set(prodotti.map((p) => p.data.category).filter(Boolean))];
---

<Layout title="Catalogo Prodotti | ProGreen Solution">
  <Navbar />

  <main class="pt-32 pb-24 min-h-screen bg-stone-50">
    <div class="max-w-7xl mx-auto px-6">
      
      <div class="text-center max-w-2xl mx-auto mb-16">
        <h1 class="text-4xl md:text-5xl font-bold text-stone-900 mb-4">Il Nostro Catalogo</h1>
        <p class="text-stone-500 text-lg">
          Esplora la nostra selezione di prodotti professionali. 
          Clicca sulle categorie per filtrare o su un prodotto per vedere la scheda tecnica.
        </p>
      </div>

      <div class="flex flex-wrap justify-center gap-3 mb-12">
        <button 
          class="filter-btn active px-6 py-2 rounded-full text-sm font-bold transition-all border border-stone-900 bg-stone-900 text-white shadow-lg cursor-pointer hover:scale-105"
          data-filter="all"
        >
          Tutti i Prodotti
        </button>

        {categorie.map((cat) => (
          <button 
            class="filter-btn px-6 py-2 rounded-full text-sm font-bold transition-all border border-stone-200 bg-white text-stone-600 hover:border-emerald-500 hover:text-emerald-600 cursor-pointer capitalize hover:scale-105"
            data-filter={cat}
          >
            {cat}
          </button>
        ))}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="griglia-prodotti">
        {prodotti.map((prodotto) => (
          // RIMOSSO IL TAG <a> CHE AVVOLGEVA TUTTO (Causava l'errore)
          <div class="prodotto-item transition-all duration-500 h-full" data-category={prodotto.data.category}>
             <ProductCard 
               title={prodotto.data.title} 
               category={prodotto.data.category} 
               image={prodotto.data.image} 
               price={prodotto.data.price}   /* Aggiunto il prezzo */
               slug={prodotto.slug}          /* Fondamentale per il link interno */
             />
          </div>
        ))}
      </div>

      <div id="nessun-risultato" class="hidden text-center py-20 bg-white rounded-3xl border border-stone-100 shadow-sm mx-auto max-w-lg mt-8">
        <div class="text-6xl mb-4">üçÇ</div>
        <p class="text-stone-900 font-bold text-xl">Nessun prodotto trovato</p>
        <p class="text-stone-500">Prova a selezionare un'altra categoria.</p>
      </div>

    </div>
  </main>
  
  <ContactSection />
</Layout>

<script>
  const buttons = document.querySelectorAll('.filter-btn');
  const items = document.querySelectorAll('.prodotto-item');
  const msgEmpty = document.getElementById('nessun-risultato');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      // 1. Reset stile bottoni
      buttons.forEach(b => {
        b.classList.remove('bg-stone-900', 'text-white', 'shadow-lg');
        b.classList.add('bg-white', 'text-stone-600', 'border-stone-200');
      });
      
      // 2. Attiva bottone corrente
      btn.classList.remove('bg-white', 'text-stone-600', 'border-stone-200');
      btn.classList.add('bg-stone-900', 'text-white', 'shadow-lg');

      // 3. Filtra elementi
      const categoriaScelta = btn.getAttribute('data-filter');
      let conteggioVisibili = 0;

      items.forEach((item) => {
        const categoriaItem = (item as HTMLElement).getAttribute('data-category');
        const elemento = item as HTMLElement;

        if (categoriaScelta === 'all' || categoriaItem === categoriaScelta) {
          elemento.style.display = 'block';
          // Piccola animazione fade-in
          requestAnimationFrame(() => {
              elemento.style.opacity = '1';
              elemento.style.transform = 'translateY(0) scale(1)';
          });
          conteggioVisibili++;
        } else {
          elemento.style.opacity = '0';
          elemento.style.transform = 'translateY(10px) scale(0.95)';
          // Aspetta la fine dell'animazione per nascondere
          setTimeout(() => {
             if(elemento.style.opacity === '0') elemento.style.display = 'none';
          }, 300);
        }
      });

      // 4. Gestione messaggio vuoto
      if (msgEmpty) {
          if (conteggioVisibili === 0) {
              msgEmpty.classList.remove('hidden');
          } else {
              msgEmpty.classList.add('hidden');
          }
      }
    });
  });
</script>