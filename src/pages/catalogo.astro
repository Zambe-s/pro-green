---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import ProductCard from '../components/ProductCard.astro';
import ContactSection from '../components/ContactSection.astro';
import { getCollection } from 'astro:content';

// Recupero tutti i prodotti
const prodotti = await getCollection('prodotti');

// Estraggo le categorie uniche per i bottoni
const categorie = [...new Set(prodotti.map((p) => p.data.category).filter(Boolean))];
---

<Layout title="Catalogo Prodotti | ProGreen Solution">
  <Navbar />

  <main class="pt-32 pb-24 min-h-screen bg-stone-50">
    <div class="max-w-7xl mx-auto px-6">
      
      <div class="text-center max-w-2xl mx-auto mb-16">
        <h1 class="text-4xl md:text-5xl font-bold text-stone-900 mb-4">Il Nostro Catalogo</h1>
        <p class="text-stone-500 text-lg">
          Esplora la nostra selezione di prodotti professionali. 
          Clicca sulle categorie per filtrare o su un prodotto per vedere la scheda tecnica.
        </p>
      </div>

      <div class="flex flex-wrap justify-center gap-3 mb-12">
        <button 
          class="filter-btn px-6 py-2 rounded-full text-sm font-bold transition-all border border-stone-200 bg-white text-stone-600 cursor-pointer hover:scale-105"
          data-filter="all"
        >
          Tutti i Prodotti
        </button>

        {categorie.map((cat) => (
          <button 
            class="filter-btn px-6 py-2 rounded-full text-sm font-bold transition-all border border-stone-200 bg-white text-stone-600 hover:border-emerald-500 hover:text-emerald-600 cursor-pointer capitalize hover:scale-105"
            data-filter={cat}
          >
            {cat}
          </button>
        ))}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="griglia-prodotti">
        {prodotti.map((prodotto) => (
          <div class="prodotto-item transition-all duration-500 h-full" data-category={prodotto.data.category}>
             <ProductCard 
               title={prodotto.data.title} 
               category={prodotto.data.category} 
               image={prodotto.data.image} 
               price={prodotto.data.price}
               slug={prodotto.slug}
             />
          </div>
        ))}
      </div>

      <div id="nessun-risultato" class="hidden text-center py-20 bg-white rounded-3xl border border-stone-100 shadow-sm mx-auto max-w-lg mt-8">
        <div class="text-6xl mb-4">üçÇ</div>
        <p class="text-stone-900 font-bold text-xl">Nessun prodotto trovato</p>
        <p class="text-stone-500">Prova a selezionare un'altra categoria.</p>
      </div>

    </div>
  </main>
  
  <ContactSection />
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
      
    const buttons = document.querySelectorAll('.filter-btn');
    const items = document.querySelectorAll('.prodotto-item');
    const msgEmpty = document.getElementById('nessun-risultato');

    const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const applicaFiltro = async (categoriaScelta, activeBtn) => {
      // 1. Reset stile bottoni
      buttons.forEach(b => {
        b.classList.remove('bg-stone-900', 'text-white', 'shadow-lg', 'border-stone-900', 'scale-105');
        b.classList.add('bg-white', 'text-stone-600', 'border-stone-200');
      });
      
      // 2. Attiva bottone corrente
      if (activeBtn) {
        activeBtn.classList.remove('bg-white', 'text-stone-600', 'border-stone-200');
        activeBtn.classList.add('bg-stone-900', 'text-white', 'shadow-lg', 'border-stone-900', 'scale-105');
      }

      // 3. Animazione e Filtro
      items.forEach((item) => {
          const el = item;
          el.style.opacity = '0';
          el.style.transform = 'scale(0.95)';
      });

      await wait(300);

      let conteggioVisibili = 0;
      items.forEach((item) => {
        const el = item;
        const categoriaItem = el.getAttribute('data-category');
        
        if (categoriaScelta === 'all' || categoriaItem === categoriaScelta) {
          el.style.display = 'block';
          conteggioVisibili++;
        } else {
          el.style.display = 'none';
        }
      });

      if (msgEmpty) {
         msgEmpty.classList.toggle('hidden', conteggioVisibili > 0);
      }

      requestAnimationFrame(() => {
          items.forEach((item) => {
              const el = item;
              if (el.style.display === 'block') {
                  setTimeout(() => {
                      el.style.opacity = '1';
                      el.style.transform = 'scale(1)';
                  }, 50); 
              }
          });
      });

      sessionStorage.setItem('categoria_selezionata', categoriaScelta);
    };

    // --- LOGICA DI AVVIO CORRETTA ---
    
    // 1. Recupera filtro (o 'all' di default)
    const filtroSalvato = sessionStorage.getItem('categoria_selezionata') || 'all';
    
    // 2. Trova il bottone da accendere
    const btnDaAttivare = Array.from(buttons).find(b => b.getAttribute('data-filter') === filtroSalvato);

    // 3. ACCENDI IL BOTTONE (Sempre, anche se √® 'all')
    if (btnDaAttivare) {
        // Reset preventivo per sicurezza
        buttons.forEach(b => b.classList.add('bg-white', 'text-stone-600'));
        // Accendi quello giusto
        btnDaAttivare.classList.remove('bg-white', 'text-stone-600', 'border-stone-200');
        btnDaAttivare.classList.add('bg-stone-900', 'text-white', 'shadow-lg', 'border-stone-900');
    }

    // 4. Applica il filtro visivo ai prodotti (solo se diverso da all serve nascondere cose)
    if (filtroSalvato !== 'all') {
         items.forEach((item) => {
            const el = item;
            if (el.getAttribute('data-category') !== filtroSalvato) el.style.display = 'none';
         });
    }

    // Listener Click
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const categoria = btn.getAttribute('data-filter');
        applicaFiltro(categoria, btn);
      });
    });

  });
</script>